{"version":3,"sources":["../../src/scripts/keyGenerate.ts","../../src/scripts/content.ts"],"sourcesContent":["export function generateRandomKey(length: number = 16): string {\n  const charset =\n    \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\";\n  const array = new Uint8Array(length);\n  crypto.getRandomValues(array);\n\n  return Array.from(array)\n    .map((byte) => charset[byte % charset.length])\n    .join(\"\");\n}\n\nexport async function generateTrackingId(\n  userId: string,\n  timestamp: number,\n  key: string\n): Promise<string> {\n  const encoder = new TextEncoder();\n  const message = encoder.encode(`${userId}:${timestamp}`);\n  const keyData = encoder.encode(key);\n\n  const cryptoKey = await crypto.subtle.importKey(\n    \"raw\",\n    keyData,\n    { name: \"HMAC\", hash: \"SHA-256\" },\n    false,\n    [\"sign\"]\n  );\n\n  const signature = await crypto.subtle.sign(\"HMAC\", cryptoKey, message);\n\n  return Array.from(new Uint8Array(signature))\n    .map((byte) => byte.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n}\n","import { error } from \"console\";\nimport { generateRandomKey, generateTrackingId } from \"./keyGenerate\";\nimport { Boxes } from \"lucide-react\";\nimport { json } from \"stream/consumers\";\nimport { promises } from \"dns\";\n\n// const token = localStorage.getItem(\"authToken\");\nconst token =\n  \"eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiI2N2Y5OTAzZWZmZTE5MTNiYjNhNTMwYzciLCJzdWIiOiJrc2hpdGlqQGdtYWlsLmNvbSIsImlhdCI6MTc0NzcwMjE0MiwiZXhwIjoxNzQ5NTAyMTQyfQ.VFHdqwKLseOge5A20zP_6YKwkZYrEkDrc70U_6mqM9k\";\n\ninterface TrackingId {\n  trackingId: string;\n  k: string;\n  u: string;\n  t: number;\n}\n\ninterface TrackingResponse {\n  status: boolean;\n  trackingId: string;\n}\n\ninterface ComposeBox {\n  id: string;\n  subjectInput: string;\n  toInput: string[];\n  bodyElement: HTMLElement;\n  trackingObject: TrackingId;\n}\n\nconst composeRegistry = new Map<string, ComposeBox>();\n\nfunction createComposeBox(\n  el: HTMLElement,\n  trackingId: string,\n  k: string,\n  u: string,\n  t: number\n): ComposeBox | null {\n  const id = el.getAttribute(\"data-compose-id\");\n  if (!id) return null;\n  const subject = el.querySelector(\n    'input[name=\"subjectbox\"]'\n  ) as HTMLInputElement;\n  const to = el.querySelector('[aria-label=\"To\"]') as HTMLElement;\n  const body = el.querySelector(\n    '[aria-label=\"Message Body\"][contenteditable=\"true\"]'\n  ) as HTMLElement;\n  if (!subject || !to || !body) return null;\n  return {\n    id,\n    subjectInput: subject.value,\n    toInput: extractRecipients(to),\n    bodyElement: body,\n    trackingObject: {\n      trackingId,\n      k,\n      u,\n      t,\n    },\n  };\n}\n\nfunction extractRecipients(el: HTMLElement): string[] {\n  const chips = el.querySelectorAll('[role=\"option\"][data-hovercard-id]');\n  return Array.from(chips)\n    .map((chip) => chip.getAttribute(\"data-hovercard-id\") || \"\")\n    .filter((email) => email !== \"\");\n}\n\nfunction finaliseDataFromComposeBox(\n  composeEl: Element | null,\n  trackingId: string,\n  k: string,\n  u: string,\n  t: number\n) {\n  if (!composeEl) {\n    console.warn(\"‚ö†Ô∏è No compose element found.\");\n    return;\n  }\n  const box = createComposeBox(composeEl as HTMLElement, trackingId, k, u, t);\n\n  console.log(\"whole box data üöÄ \", box);\n\n  if (!box) {\n    console.warn(\"‚ö†Ô∏è Could not construct ComposeBox.\");\n    return;\n  }\n\n  insertImageIntoEmail(trackingId, box.bodyElement);\n  console.log(\n    \"‚úÖ Pixel inserted into compose box:\",\n    box.id,\n    box.subjectInput,\n    box.toInput\n  );\n\n  return box;\n}\n\nfunction attachTrackerOnSendButton() {\n  const sendButton = document.querySelectorAll(\n    \"div.T-I.J-J5-Ji.aoO.v7.T-I-atl.L3\"\n  ) as NodeListOf<HTMLElement>;\n\n  console.log(\"Number of send buttons:\", sendButton.length);\n\n  sendButton.forEach((send: HTMLElement) => {\n    if (!send || send.dataset.trackerInjected === \"true\") return;\n    send.dataset.trackerInjected = \"true\";\n\n    const clonedButton = send.cloneNode(true) as HTMLElement;\n    send.replaceWith(clonedButton);\n\n    clonedButton.addEventListener(\"click\", async function handler(e) {\n      e.preventDefault();\n      e.stopPropagation();\n\n      clonedButton.removeEventListener(\"click\", handler);\n\n      const k = generateRandomKey();\n      const u = \"kshitij@gmail.com\";\n      const t = Date.now();\n\n      const trackingId = await generateTrackingId(u, t, k);\n\n      const composeBoxEl = clonedButton.closest(\"[data-compose-id]\");\n\n      const box: ComposeBox | undefined = finaliseDataFromComposeBox(\n        composeBoxEl,\n        trackingId,\n        k,\n        u,\n        t\n      );\n\n      if (box != undefined) {\n        registerTrackingId(box);\n      } else {\n        console.warn(\"‚ùå ComposeBox creation failed\");\n      }\n\n      send.click();\n    });\n  });\n}\n\nfunction registerTrackingId(box: ComposeBox) {\n  const payload = {\n    trackingObject: box.trackingObject,\n    to: box.toInput,\n    subject: box.subjectInput,\n  };\n\n  composeRegistry.set(box.trackingObject.trackingId, box);\n\n  fetch(\"http://localhost:8080/tracking/ids\", {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      Authorization: `Bearer ${token}`,\n    },\n    body: JSON.stringify(payload),\n  })\n    .then(async (response) => {\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(`Server returned ${response.status}: ${errorText}`);\n      }\n      return response.json() as Promise<TrackingResponse>;\n    })\n    .then((data) => {\n      if (!data) return;\n      console.log(data);\n      if (data.status === true) {\n        composeRegistry.delete(data.trackingId!);\n        console.log(\"‚úÖ Tracking ID uploaded successfully:\", data.trackingId);\n      } else {\n        const reDeclare = composeRegistry.get(data?.trackingId);\n        if (reDeclare) registerTrackingId(reDeclare);\n        console.warn(\"‚ö†Ô∏è Server responded with failure. ID:\", data.trackingId);\n      }\n    })\n    .catch((error) => {\n      console.error(\"‚ùå Network or unexpected error:\", error);\n    });\n}\n\nfunction insertImageIntoEmail(trackingId: string, element: HTMLElement) {\n  // const trackingUrl = `http://localhost:8080/track/${trackingId}`;\n  const trackingUrl = `https://mail-tracker-xy4c.onrender.com/track/${trackingId}`;\n  // const trackingUrl = `https://cdn.pixabay.com/photo/2025/04/14/16/31/animals-9533774_1280.jpg`;\n\n  const img = document.createElement(\"img\");\n  img.src = trackingUrl;\n  img.width = 10;\n  img.height = 10;\n  img.style.backgroundColor = \"red\";\n  img.style.border = \"1px solid black\";\n  img.style.display = \"inline-block\";\n  img.alt = \"debug pixel\";\n\n  element.appendChild(img);\n}\n\nfunction getEmailBodyContainers(): HTMLElement {\n  const emailBodies = document.querySelector(\n    '[aria-label=\"Message Body\"][contenteditable=\"true\"]'\n  ) as HTMLElement;\n  return emailBodies;\n}\n\n// function insertImageIntoEmail() {\n//   const composeButton = document.querySelector(\n//     \".T-I.T-I-KE.L3\"\n//   ) as HTMLElement | null;\n\n//   if (composeButton && !composeButton.dataset.trackerRenamed) {\n//     composeButton.dataset.trackerRenamed = \"true\";\n//   }\n\n//   if (!composeButton || composeButton.dataset.trackerInjected === \"true\")\n//     return;\n\n//   composeButton.dataset.trackerInjected = \"true\";\n\n//   composeButton.addEventListener(\"click\", async function handler(e) {\n//     currentTrackingId = await generateKey();\n//     const trackingUrl = `http://localhost:8080/track/${currentTrackingId}`;\n\n//     setTimeout(() => {\n//       const emailBodies = document.querySelectorAll(\n//         '[aria-label=\"Message Body\"]'\n//       );\n\n//       emailBodies.forEach((body) => {\n//         const htmlBody = body as HTMLElement;\n\n//         if (htmlBody.dataset.pixelInjected === \"true\") return;\n//         htmlBody.dataset.pixelInjected = \"true\";\n\n//         const img = document.createElement(\"img\");\n//         img.src = trackingUrl;\n//         img.width = 10;\n//         img.height = 10;\n//         img.style.backgroundColor = \"red\";\n//         img.style.border = \"1px solid black\";\n//         img.style.display = \"inline-block\";\n//         img.alt = \"debug pixel\";\n\n//         htmlBody.appendChild(img);\n//         console.log(\"üñºÔ∏è Tracking pixel injected\");\n//       });\n//     },300);\n//   });\n// }\n\nfunction highlightGmailHeader() {\n  const headerBar = document.querySelector(\"header\");\n\n  if (headerBar && !headerBar.dataset.extModified) {\n    headerBar.style.backgroundColor = \"#FFBE98\";\n    headerBar.dataset.extModified = \"true\";\n    console.log(\"üüß Mail Tracker extension active ‚Äì header modified\");\n  }\n}\n\nconst sendButtonObserver = new MutationObserver(() => {\n  attachTrackerOnSendButton();\n});\n\nsendButtonObserver.observe(document.body, {\n  childList: true,\n  subtree: true,\n});\n\nconst headerObserver = new MutationObserver(() => {\n  highlightGmailHeader();\n});\n\nheaderObserver.observe(document.body, {\n  childList: true,\n  subtree: true,\n});\n\n// const insertImageIntoEmailObserver = new MutationObserver(() => {\n//   insertImageIntoEmail();\n// });\n\n// insertImageIntoEmailObserver.observe(document.body, {\n//   childList: true,\n//   subtree: true,\n// });\n\n// window.addEventListener(\"load\", () => {\n//   interceptGmailSend();\n//   highlightGmailHeader();\n//   insertImageIntoEmail();\n// });\n\n// http://localhost:8080/track/6dc553055dfb0d013fc0fb99bee829bc41674d122701469afadc59c02625cad0\n"],"mappings":"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","names":[]}